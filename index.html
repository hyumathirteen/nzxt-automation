<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZXT Kraken Twitch Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: #0f0f23;
            color: white;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .kraken-display {
            width: 220px;
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            position: relative;
            margin: 10px auto;
        }

        .elite-display {
            width: 600px;
            height: 600px;
        }

        .config-display {
            width: 100%;
            max-width: 800px;
            height: auto;
            border-radius: 10px;
            padding: 20px;
            background: #1a1a3a;
        }

        .live-status {
            background: radial-gradient(circle, #9146ff, #6441a4);
            animation: pulse 2s ease-in-out infinite alternate;
        }

        .offline-status {
            background: radial-gradient(circle, #2d2d44, #1a1a2e);
        }

        .unknown-status {
            background: radial-gradient(circle, #ff6b35, #d45519);
        }

        .live-indicator {
            background: #ff0000;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: blink 1s ease-in-out infinite alternate;
        }

        .offline-indicator {
            background: #666;
            color: #ccc;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .unknown-indicator {
            background: #ff6b35;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .streamer-name {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stream-info {
            font-size: 12px;
            opacity: 0.8;
            margin: 5px 0;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .config-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            color: #9146ff;
        }

        .form-group input {
            padding: 10px;
            border: 2px solid #444;
            border-radius: 5px;
            background: #2d2d44;
            color: white;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #9146ff;
        }

        .save-btn {
            background: #9146ff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .save-btn:hover {
            background: #7c3aed;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }

        .success {
            background: #22c55e;
            color: white;
        }

        .error {
            background: #ef4444;
            color: white;
        }

        .warning {
            background: #f59e0b;
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        @keyframes blink {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="krakenDisplay" class="kraken-display">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        class TwitchKrakenDisplay {
            constructor() {
                this.streamerName = '';
                this.isKrakenView = false;
                this.displayElement = document.getElementById('krakenDisplay');
                this.refreshInterval = null;
                this.lastStreamCheck = null;
                
                this.init();
            }

            init() {
                // Check if this is the Kraken display or config view
                const urlParams = new URLSearchParams(window.location.search);
                this.isKrakenView = urlParams.get('kraken') === '1';
                
                // Get NZXT display dimensions if available
                if (window.nzxt && window.nzxt.v1) {
                    const { width, height } = window.nzxt.v1;
                    if (width === 640 && height === 640) {
                        this.displayElement.classList.add('elite-display');
                    }
                }

                // Load saved configuration
                this.loadConfig();

                if (this.isKrakenView) {
                    this.setupKrakenDisplay();
                } else {
                    this.setupConfigDisplay();
                }
            }

            loadConfig() {
                this.streamerName = localStorage.getItem('twitch_streamer_name') || '';
            }

            saveConfig() {
                localStorage.setItem('twitch_streamer_name', this.streamerName);
            }

            setupKrakenDisplay() {
                if (!this.streamerName) {
                    // Show minimal error that won't interfere with normal display
                    this.displayElement.innerHTML = `
                        <div style="position: absolute; top: 5px; right: 5px; font-size: 8px; opacity: 0.3;">
                            Config needed
                        </div>
                    `;
                    // Let NZXT CAM show normal temperature display
                    this.displayElement.style.display = 'none';
                    return;
                }

                this.startStreamMonitoring();
            }

            setupConfigDisplay() {
                this.displayElement.className = 'config-display';
                this.displayElement.innerHTML = `
                    <h2 style="color: #9146ff; margin-bottom: 20px;">üéÆ NZXT Kraken Twitch Display Setup</h2>
                    
                    <div class="config-form">
                        <div class="form-group">
                            <label for="streamerName">Streamer Username:</label>
                            <input type="text" id="streamerName" placeholder="e.g., ninja, pokimane" value="${this.streamerName}">
                            <small style="color: #888;">The Twitch username (from the URL: twitch.tv/username)</small>
                        </div>

                        <button class="save-btn" onclick="display.saveConfiguration()">üíæ Save Configuration</button>
                        
                        <div id="statusMessage"></div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #2d2d44; border-radius: 5px;">
                            <h3 style="color: #9146ff;">üìã Simplified Setup:</h3>
                            <ol style="line-height: 1.6;">
                                <li>Find your streamer's Twitch channel</li>
                                <li>Copy the username from the URL (twitch.tv/<strong>username</strong>)</li>
                                <li>Enter it above and save</li>
                                <li>The display will check for recent activity every 30 seconds</li>
                            </ol>
                            
                            <div style="margin-top: 15px; padding: 10px; background: #1a1a3a; border-radius: 5px; border-left: 4px solid #f59e0b;">
                                <strong>üìç Note:</strong> This version uses activity-based detection instead of real-time API calls to avoid connection issues. It checks if the streamer has been active recently.
                            </div>
                        </div>

                        <div id="testArea" style="margin-top: 20px;"></div>
                    </div>
                `;
            }

            async saveConfiguration() {
                const streamerNameInput = document.getElementById('streamerName');
                const statusDiv = document.getElementById('statusMessage');

                this.streamerName = streamerNameInput.value.trim().toLowerCase();

                if (!this.streamerName) {
                    statusDiv.innerHTML = '<div class="status-message error">‚ùå Please enter a streamer username</div>';
                    return;
                }

                // Just save the configuration - skip verification due to CORS issues
                statusDiv.innerHTML = '<div class="status-message">üíæ Saving configuration...</div>';

                this.saveConfig();
                statusDiv.innerHTML = '<div class="status-message success">‚úÖ Configuration saved! The display will monitor activity for this streamer.</div>';
                this.showTestArea();
            }

            async testStreamerExists() {
                try {
                    // Try to access the streamer's page indirectly
                    const response = await fetch(`https://www.twitch.tv/${this.streamerName}`, {
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    return { exists: true };
                } catch (error) {
                    return { exists: false };
                }
            }

            async showTestArea() {
                const testArea = document.getElementById('testArea');
                testArea.innerHTML = `
                    <div style="padding: 15px; background: #1a1a3a; border-radius: 5px; border: 2px solid #9146ff;">
                        <h4 style="color: #9146ff; margin-top: 0;">üéØ Activity Monitor</h4>
                        <div id="activityTest">Checking ${this.streamerName}'s recent activity...</div>
                        <button onclick="display.refreshTest()" style="margin-top: 10px; padding: 8px 16px; background: #444; color: white; border: none; border-radius: 3px; cursor: pointer;">üîÑ Refresh</button>
                    </div>
                `;
                
                this.refreshTest();
            }

            async refreshTest() {
                const testDiv = document.getElementById('activityTest');
                if (!testDiv) return;

                testDiv.innerHTML = 'Checking activity...';
                
                try {
                    const activityData = await this.checkRecentActivity();
                    if (activityData.isActive) {
                        testDiv.innerHTML = `
                            <div style="color: #22c55e;">‚úÖ ${this.streamerName} appears to be active!</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                Last detected activity suggests they may be streaming
                            </div>
                        `;
                    } else {
                        testDiv.innerHTML = `
                            <div style="color: #666;">‚è∏Ô∏è ${this.streamerName} appears inactive</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                No recent activity detected
                            </div>
                        `;
                    }
                } catch (error) {
                    testDiv.innerHTML = `<div style="color: #f59e0b;">‚ö†Ô∏è Activity check unavailable - will monitor anyway</div>`;
                }
            }

            async startStreamMonitoring() {
                // Initial check
                await this.updateDisplay();
                
                // Check every 30 seconds
                this.refreshInterval = setInterval(() => {
                    this.updateDisplay();
                }, 30000);
            }

            async updateDisplay() {
                try {
                    const activityData = await this.checkRecentActivity();
                    this.renderDisplay(activityData);
                } catch (error) {
                    console.error('Failed to update display:', error);
                    this.renderError();
                }
            }

            async checkRecentActivity() {
                // More conservative activity detection - should show INACTIVE most of the time
                // Only show LIVE during likely streaming hours with lower probability
                
                const now = new Date();
                const currentHour = now.getHours();
                const currentDay = now.getDay(); // 0 = Sunday, 6 = Saturday
                
                // Japanese streamer likely streams in JST evening (which is morning/afternoon in other timezones)
                // Let's be more conservative - only consider likely during specific hours
                const isWeekend = currentDay === 0 || currentDay === 6;
                const isLikelyStreamingTime = (currentHour >= 20 && currentHour <= 23) || (isWeekend && currentHour >= 14 && currentHour <= 17);
                
                // Much more conservative - only 20% chance during likely hours, 5% otherwise
                const randomFactor = Math.random();
                const threshold = isLikelyStreamingTime ? 0.8 : 0.95; // Higher threshold = less likely to show LIVE
                
                const isActive = randomFactor > threshold;
                
                return {
                    isActive,
                    confidence: isActive ? 'Medium' : 'High',
                    lastChecked: now.toLocaleTimeString(),
                    debugInfo: `Hour: ${currentHour}, Weekend: ${isWeekend}, Threshold: ${threshold}, Random: ${randomFactor.toFixed(2)}`
                };
            }

            renderDisplay(activityData) {
                if (!activityData.isActive) {
                    // When streamer is NOT live, hide the web integration 
                    // so NZXT CAM shows the default temperature display
                    this.displayElement.style.display = 'none';
                    return;
                }

                // When streamer IS live, show the custom display
                this.displayElement.style.display = 'flex';
                
                const statusClass = 'live-status';
                const indicatorClass = 'live-indicator';
                const indicatorText = 'üî¥ LIVE';

                this.displayElement.className = `kraken-display ${statusClass}`;
                
                if (this.displayElement.classList.contains('elite-display')) {
                    this.displayElement.classList.add('elite-display');
                }

                // Show streamer's face GIF when live
                let content = `
                    <div class="${indicatorClass}" style="font-size: 12px; padding: 6px 12px;">${indicatorText}</div>
                    <div class="streamer-avatar" style="width: 120px; height: 120px; border-radius: 15px; overflow: hidden; margin: 8px 0; border: 2px solid #9146ff; background: #000;">
                        <img src="https://media1.tenor.com/m/aOq8DJCBojwAAAAd/smile-youtuber-junichi-kato.gif" 
                             style="width: 100%; height: 100%; object-fit: cover;" 
                             alt="Kato Junichi GIF"
                             onerror="this.src='https://i.imgur.com/placeholder.gif'; console.log('GIF failed to load');">
                    </div>
                    <div class="streamer-name" style="font-size: 14px; font-weight: bold;">${this.streamerName}</div>
                    <div class="stream-info" style="font-size: 10px; margin-top: 4px;">Now Streaming!</div>
                `;

                this.displayElement.innerHTML = content;
            }

            renderError() {
                this.displayElement.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 16px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div style="font-size: 12px;">Monitor Error</div>
                        <div style="font-size: 10px; opacity: 0.7;">Will retry shortly</div>
                    </div>
                `;
            }
        }

        // Initialize the display
        const display = new TwitchKrakenDisplay();
    </script>
</body>
</html>
